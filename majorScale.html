<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Major Scales Trainer - Interactive Music Theory Learning Tool | paveu.pl</title>

    <meta name="description" content="Interactive Major Scales Trainer for learning all 15 major scales and their chords. Practice with drag-and-drop, keyboard navigation, instant validation, and color-coded columns. Perfect for music students and teachers.">
    <meta name="keywords" content="Major Scales, Music Theory, Chord Trainer, Music Education, Interactive Learning, Piano Scales, Guitar Scales, Music Practice, Triads, Scale Degrees, Music Theory App, Learning Tool">
    <meta name="author" content="Paweł Stępak">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="generator" content="Custom HTML">
    <meta name="copyright" content="Paweł Stępak">

    <meta property="og:title" content="Major Scales Trainer - Interactive Music Theory Tool">
    <meta property="og:description" content="Learn all 15 major scales with interactive drag-and-drop exercises. Features instant validation, keyboard navigation, and color-coded chord groups for effective music theory practice.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://paveu.pl/majorScale.html">
    <meta property="og:site_name" content="paveu.pl - Music Theory Tools">
    <meta property="og:locale" content="en_US">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Major Scales Trainer - Interactive Music Theory Tool">
    <meta name="twitter:description" content="Learn all 15 major scales with interactive drag-and-drop exercises. Features instant validation, keyboard navigation, and color-coded chord groups.">

    <link rel="canonical" href="https://paveu.pl/majorScale.html">
    <meta name="theme-color" content="#5c6bc0">
    <meta name="msapplication-TileColor" content="#5c6bc0">
    <meta name="format-detection" content="telephone=no">

    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Theme variables */
        :root[data-theme="light-minimal"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #cccccc;
            --hover-bg: #f0f0f0;
            --correct: #4caf50;
            --incorrect: #f44336;
            --accent: #5c6bc0;
            --button-bg: #5c6bc0;
            --button-hover: #3f51b5;
            --header-bg: #e0e0e0;
            --primary-header: #dc3545;
            --primary-cell: #ffe5e8;
            --secondary-header: #0d6efd;
            --secondary-cell: #e7f1ff;
            --diminished-header: #198754;
            --diminished-cell: #e8f5e9;
        }

        :root[data-theme="dark-minimal"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #444444;
            --hover-bg: #3a3a3a;
            --correct: #4caf50;
            --incorrect: #f44336;
            --accent: #7986cb;
            --button-bg: #5c6bc0;
            --button-hover: #7986cb;
            --header-bg: #2a2a2a;
            --primary-header: #dc3545;
            --primary-cell: #3d1f23;
            --secondary-header: #0d6efd;
            --secondary-cell: #1a2a3d;
            --diminished-header: #198754;
            --diminished-cell: #1f3d2a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        /* Back to home link */
        .back-to-home {
            position: fixed;
            top: 20px;
            left: 20px;
            display: inline-block;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .back-to-home:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
            transform: translateX(-3px);
        }

        /* Start screen */
        #startScreen {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .config-section {
            margin-bottom: 30px;
        }

        .features-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .features-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .features-list {
            list-style: none;
            padding-left: 0;
        }

        .features-list li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            line-height: 1.5;
        }

        .features-list li::before {
            content: "•";
            position: absolute;
            left: 8px;
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2em;
        }

        .features-list strong {
            color: var(--accent);
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .start-button {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            background: var(--button-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-button:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Main screen */
        #mainScreen {
            display: none;
        }

        .main-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            color: white;
            background: var(--button-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        /* Timer display */
        .timer-display {
            padding: 12px 24px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .timer-display.warning {
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .timer-display.danger {
            color: #ef4444;
            border-color: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Chord bank */
        .chord-bank {
            flex: 0 0 280px;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            max-height: none;
            overflow-y: visible;
        }

        .chord-bank h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .chords-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chord-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chord-group-label {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 4px;
            padding-left: 4px;
        }

        .chord-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chord {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
            text-align: center;
            flex: 0 0 auto;
        }

        .chord:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .chord.dragging {
            opacity: 0.5;
        }

        /* Scale checkboxes */
        .scale-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scale-checkbox:hover {
            background: var(--hover-bg);
        }

        .scale-checkbox input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .scale-checkbox label {
            cursor: pointer;
            user-select: none;
        }

        #scaleCheckboxes {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        #scaleCheckboxes > div {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        #checkBtn {
            display: none;
        }

        /* Table */
        .table-wrapper {
            flex: 1;
            min-width: 0;
        }

        .table-container {
            overflow-x: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            table-layout: fixed;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-size: 0.9em;
            width: auto;
            min-width: 80px;
        }

        th {
            background: var(--header-bg);
            font-weight: bold;
        }

        .header-row-1 th {
            font-size: 1em;
            font-weight: bold;
        }

        .header-row-2 th {
            font-size: 0.85em;
            font-style: italic;
        }

        .header-row-3 th {
            font-size: 0.85em;
        }

        .header-row-4 th {
            font-size: 0.9em;
            font-weight: 600;
        }

        /* Column colors by chord groups */
        .col-primary {
            background: var(--primary-header);
            color: white;
        }

        .cell-primary {
            background: var(--primary-cell) !important;
        }

        .col-secondary {
            background: var(--secondary-header);
            color: white;
        }

        .cell-secondary {
            background: var(--secondary-cell) !important;
        }

        .col-diminished {
            background: var(--diminished-header);
            color: white;
        }

        .cell-diminished {
            background: var(--diminished-cell) !important;
        }

        .scale-cell {
            font-weight: bold;
            background: var(--bg-tertiary);
            position: relative;
        }

        .scale-cell .clear-row-btn {
            position: absolute;
            top: 2px;
            right: 4px;
            width: auto;
            height: auto;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            display: none;
            font-weight: bold;
            z-index: 10;
            padding: 2px;
            opacity: 0.6;
        }

        .scale-cell.has-chords .clear-row-btn {
            display: block;
        }

        .scale-cell .clear-row-btn:hover {
            opacity: 1;
            color: var(--incorrect);
        }

        .info-cell {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Drop zone */
        .drop-zone {
            min-height: 50px;
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }

        .drop-zone:hover:not(.filled) {
            background: var(--hover-bg);
            border-color: var(--accent);
        }

        .drop-zone.filled {
            cursor: default;
        }

        .drop-zone.drag-over {
            background: var(--hover-bg);
            border-color: var(--accent);
            border-style: solid;
        }

        .drop-zone.filled {
            background: transparent;
            border-style: solid;
        }

        .drop-zone.correct {
            background: transparent;
            border-color: transparent;
        }

        .drop-zone.incorrect {
            background: var(--incorrect);
            color: white;
            border-color: var(--incorrect);
        }

        .drop-zone .remove-btn {
            position: absolute;
            top: 2px;
            right: 4px;
            width: auto;
            height: auto;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            display: none;
            font-weight: bold;
            z-index: 10;
            padding: 2px;
            opacity: 0.6;
        }

        .drop-zone.filled .remove-btn {
            display: block;
        }

        .drop-zone.incorrect .remove-btn {
            color: white;
            opacity: 0.8;
        }

        .drop-zone .remove-btn:hover {
            opacity: 1;
            color: var(--incorrect);
        }

        .drop-zone.incorrect .remove-btn:hover {
            color: white;
            opacity: 1;
        }

        .drop-zone .chord-text {
            padding-right: 20px;
            font-weight: bold;
        }

        /* Chord selection modal */
        #chordModal {
            display: none;
            position: fixed;
            z-index: 10000;
            background: var(--bg-primary);
            border: 2px solid #000000;
            border-radius: 8px;
            padding: 8px;
            padding-top: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            max-height: 350px;
            height: 350px;
            overflow-y: scroll;
        }

        #chordModal.active {
            display: block !important;
            visibility: visible !important;
        }

        #chordModal .close-modal-btn {
            position: sticky;
            top: 0;
            float: right;
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 300;
            z-index: 10001;
            padding: 0;
            margin-bottom: 8px;
        }

        #chordModal .close-modal-btn:hover {
            background: var(--incorrect);
            color: white;
            border-color: var(--incorrect);
        }

        .modal-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.95em;
            margin-bottom: 2px;
            border: 1px solid transparent;
            user-select: none;
        }

        .modal-option.keyboard-focused {
            background: var(--accent);
            color: white;
        }

        .progress {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #startScreen {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .main-content {
                flex-direction: column;
            }

            .chord-bank {
                flex: 1;
                width: 100%;
                max-height: 300px;
            }

            .table-wrapper {
                width: 100%;
            }

            th, td {
                padding: 8px 4px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start screen -->
        <div id="startScreen">
            <a href="https://paveu.pl" class="back-to-home">← Back to paveu.pl</a>

            <h1>🎵 Major Scales Trainer</h1>

            <div class="config-section">
                <h3>Exercise Mode</h3>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="mode" value="all" checked>
                        <span>All scales (15 scales)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="mode" value="custom">
                        <span>Select scales to practice</span>
                    </label>
                    <div id="scaleCheckboxes">
                        <div></div>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>Difficulty Level</h3>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="difficulty" value="all" checked>
                        <span>All chords</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="difficulty" value="scale">
                        <span>Only chords from selected scales</span>
                    </label>
                </div>
            </div>

            <div class="config-section">
                <h3>Validation Mode</h3>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="validation" value="instant" checked>
                        <span>Instant validation</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="validation" value="manual">
                        <span>Manual validation</span>
                    </label>
                </div>
            </div>

            <div class="config-section">
                <h3>Practice Timer</h3>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="timer-mode" value="no-timer" checked>
                        <span>No timer</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="timer-mode" value="custom">
                        <span>Number of minutes:</span>
                        <input type="number" id="timerMinutes" min="1" max="120" value="10"
                               style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); width: 80px;">
                    </label>
                </div>
            </div>

            <div class="config-section">
                <h3>Theme</h3>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="theme" value="light-minimal">
                        <span>Light Minimal</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="theme" value="dark-minimal" checked>
                        <span>Dark Minimal</span>
                    </label>
                </div>
            </div>

            <button class="start-button" onclick="startApp()">START</button>

            <div class="features-section">
                <h3>✨ Features</h3>
                <ul class="features-list">
                    <li><strong>15 Major Scales</strong> - Practice all major scales from C to Cb</li>
                    <li><strong>Drag & Drop</strong> - Drag chords from the bank or click cells to select</li>
                    <li><strong>Keyboard Navigation</strong> - Press letter keys to jump to chords in dropdown</li>
                    <li><strong>Custom Practice</strong> - Choose specific scales or practice all at once</li>
                    <li><strong>Smart Validation</strong> - Instant feedback or manual checking</li>
                    <li><strong>Color-Coded Columns</strong> - I/IV/V (red), II/III/VI (blue), VII (green)</li>
                    <li><strong>Quick Reset</strong> - Clear individual cells, entire scales, or all at once</li>
                    <li><strong>Two Themes</strong> - Light and dark minimal modes</li>
                </ul>
            </div>
        </div>

        <!-- Main screen -->
        <div id="mainScreen">
            <a href="https://paveu.pl" class="back-to-home">← Back to paveu.pl</a>

            <h1>🎵 Major Scales Trainer</h1>

            <div class="controls">
                <button class="btn" onclick="showStartScreen()">← Menu</button>
                <button class="btn" onclick="resetApp()">🔄 Reset</button>
                <div id="timerDisplay" class="timer-display" style="display: none;">
                    ⏱️ <span id="timerText">00:00</span>
                </div>
                <div class="progress" id="progress"></div>
                <button class="btn" id="checkBtn" onclick="checkAllAnswers()">✓ Check</button>
            </div>

            <div class="main-content">
                <div class="chord-bank">
                    <h3>Chord Bank (Drag & Drop)</h3>
                    <div class="chords-container" id="chordBank"></div>
                </div>

                <div class="table-wrapper">
                    <div class="table-container">
                        <table id="scalesTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chord selection modal -->
    <div id="chordModal"></div>

    <script>
        // Scale data with chords (triads) and accidentals
        const scales = {
            'C': {chords: ['C', 'Dm', 'Em', 'F', 'G', 'Am', 'Bdim'], accidentals: '0'},
            'G': {chords: ['G', 'Am', 'Bm', 'C', 'D', 'Em', 'F#dim'], accidentals: '1#'},
            'D': {chords: ['D', 'Em', 'F#m', 'G', 'A', 'Bm', 'C#dim'], accidentals: '2#'},
            'A': {chords: ['A', 'Bm', 'C#m', 'D', 'E', 'F#m', 'G#dim'], accidentals: '3#'},
            'E': {chords: ['E', 'F#m', 'G#m', 'A', 'B', 'C#m', 'D#dim'], accidentals: '4#'},
            'B': {chords: ['B', 'C#m', 'D#m', 'E', 'F#', 'G#m', 'A#dim'], accidentals: '5#'},
            'F#': {chords: ['F#', 'G#m', 'A#m', 'B', 'C#', 'D#m', 'E#dim'], accidentals: '6#'},
            'C#': {chords: ['C#', 'D#m', 'E#m', 'F#', 'G#', 'A#m', 'B#dim'], accidentals: '7#'},
            'F': {chords: ['F', 'Gm', 'Am', 'Bb', 'C', 'Dm', 'Edim'], accidentals: '1b'},
            'Bb': {chords: ['Bb', 'Cm', 'Dm', 'Eb', 'F', 'Gm', 'Adim'], accidentals: '2b'},
            'Eb': {chords: ['Eb', 'Fm', 'Gm', 'Ab', 'Bb', 'Cm', 'Ddim'], accidentals: '3b'},
            'Ab': {chords: ['Ab', 'Bbm', 'Cm', 'Db', 'Eb', 'Fm', 'Gdim'], accidentals: '4b'},
            'Db': {chords: ['Db', 'Ebm', 'Fm', 'Gb', 'Ab', 'Bbm', 'Cdim'], accidentals: '5b'},
            'Gb': {chords: ['Gb', 'Abm', 'Bbm', 'Cb', 'Db', 'Ebm', 'Fdim'], accidentals: '6b'},
            'Cb': {chords: ['Cb', 'Dbm', 'Ebm', 'Fb', 'Gb', 'Abm', 'Bdim'], accidentals: '7b'}
        };

        // Table header rows
        const headerRows = [
            ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'Num #/b'],
            ['Tonic', 'Supertonic', 'Mediant', 'Subdominant', 'Dominant', 'Submediant', 'Leading Tone', ''],
            ['Unison', 'T', 'T', 'S', 'T', 'T', 'T', 'Octave S'],
            ['Major', 'Minor', 'Minor', 'Major', 'Major', 'Minor', 'Dim', '']
        ];

        // Application state
        let config = {
            mode: 'all',
            selectedScales: [],
            difficulty: 'all',
            validation: 'instant',
            theme: 'dark-minimal',
            timer: 0
        };

        let userAnswers = {};
        let draggedChord = null;
        let currentDropZone = null;
        let timerInterval = null;
        let timerSeconds = 0;

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            populateScaleCheckboxes();
            setupStartScreenListeners();

            const modeRadio = document.querySelector('input[name="mode"]:checked');
            if (modeRadio && modeRadio.value === 'custom') {
                document.getElementById('scaleCheckboxes').style.display = 'block';
            }

            const themeRadio = document.querySelector('input[name="theme"]:checked');
            if (themeRadio) {
                document.documentElement.setAttribute('data-theme', themeRadio.value);
            } else {
                document.documentElement.setAttribute('data-theme', 'dark-minimal');
            }
        });

        function populateScaleCheckboxes() {
            const container = document.querySelector('#scaleCheckboxes > div');
            Object.keys(scales).forEach(scale => {
                const wrapper = document.createElement('div');
                wrapper.className = 'scale-checkbox';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'scale-' + scale;
                checkbox.value = scale;

                const label = document.createElement('label');
                label.htmlFor = 'scale-' + scale;
                label.textContent = scale;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                wrapper.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });

                container.appendChild(wrapper);
            });
        }

        function setupStartScreenListeners() {
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const checkboxContainer = document.getElementById('scaleCheckboxes');
                    checkboxContainer.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            });

            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.documentElement.setAttribute('data-theme', e.target.value);
                });
            });
        }

        function startApp() {
            config.mode = document.querySelector('input[name="mode"]:checked').value;

            if (config.mode === 'custom') {
                const checkboxes = document.querySelectorAll('#scaleCheckboxes input[type="checkbox"]:checked');
                config.selectedScales = Array.from(checkboxes).map(cb => cb.value);

                if (config.selectedScales.length === 0) {
                    alert('Please select at least one scale!');
                    return;
                }
            } else {
                config.selectedScales = Object.keys(scales);
            }

            config.difficulty = document.querySelector('input[name="difficulty"]:checked').value;
            config.validation = document.querySelector('input[name="validation"]:checked').value;
            config.theme = document.querySelector('input[name="theme"]:checked').value;

            // Get timer configuration
            const timerMode = document.querySelector('input[name="timer-mode"]:checked').value;
            if (timerMode === 'custom') {
                const timerMinutes = parseInt(document.getElementById('timerMinutes').value);
                if (timerMinutes < 1 || timerMinutes > 120) {
                    alert('Please enter a valid number of minutes (1-120)');
                    return;
                }
                config.timer = timerMinutes;
            } else {
                config.timer = 0;
            }

            document.documentElement.setAttribute('data-theme', config.theme);

            const checkBtn = document.getElementById('checkBtn');
            if (config.validation === 'manual') {
                checkBtn.style.display = 'inline-block';
            } else {
                checkBtn.style.display = 'none';
            }

            // Setup timer if selected
            const timerDisplay = document.getElementById('timerDisplay');
            if (config.timer > 0) {
                timerDisplay.style.display = 'inline-flex';
                startTimer(config.timer);
            } else {
                timerDisplay.style.display = 'none';
            }

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';

            buildChordBank();
            buildTable();
            updateProgress();
        }

        function startTimer(minutes) {
            timerSeconds = minutes * 60;
            updateTimerDisplay();

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    alert('⏰ Time is up! Practice session completed.');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timeText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const timerText = document.getElementById('timerText');
            const timerDisplay = document.getElementById('timerDisplay');

            timerText.textContent = timeText;

            // Change color based on remaining time
            timerDisplay.classList.remove('warning', 'danger');
            if (timerSeconds <= 60) {
                timerDisplay.classList.add('danger');
            } else if (timerSeconds <= 180) {
                timerDisplay.classList.add('warning');
            }
        }

        function showStartScreen() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            resetApp();
        }

        function buildChordBank() {
            const bank = document.getElementById('chordBank');
            bank.innerHTML = '';

            let chords = [];

            if (config.difficulty === 'all') {
                Object.values(scales).forEach(scale => {
                    chords = chords.concat(scale.chords);
                });
                chords = [...new Set(chords)];
            } else {
                config.selectedScales.forEach(scaleName => {
                    chords = chords.concat(scales[scaleName].chords);
                });
                chords = [...new Set(chords)];
            }

            const chordGroups = {
                'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [], 'G': []
            };

            chords.forEach(chord => {
                const baseNote = chord.charAt(0);
                if (chordGroups[baseNote]) {
                    chordGroups[baseNote].push(chord);
                }
            });

            ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(note => {
                if (chordGroups[note].length > 0) {
                    chordGroups[note].sort();

                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'chord-group';

                    const label = document.createElement('div');
                    label.className = 'chord-group-label';
                    label.textContent = note + ':';
                    groupDiv.appendChild(label);

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'chord-row';

                    chordGroups[note].forEach(chord => {
                        const chordEl = document.createElement('div');
                        chordEl.className = 'chord';
                        chordEl.textContent = chord;
                        chordEl.draggable = true;
                        chordEl.dataset.chord = chord;

                        chordEl.addEventListener('dragstart', handleDragStart);
                        chordEl.addEventListener('dragend', handleDragEnd);

                        rowDiv.appendChild(chordEl);
                    });

                    groupDiv.appendChild(rowDiv);
                    bank.appendChild(groupDiv);
                }
            });
        }

        function buildTable() {
            const table = document.getElementById('scalesTable');
            table.innerHTML = '';

            const thead = document.createElement('thead');

            headerRows.forEach((row, index) => {
                const headerRow = document.createElement('tr');
                headerRow.className = 'header-row-' + (index + 1);

                const scaleHeader = document.createElement('th');
                scaleHeader.textContent = index === 0 ? 'Scale' : '';
                scaleHeader.rowSpan = index === 0 ? 4 : 1;
                if (index === 0) {
                    headerRow.appendChild(scaleHeader);
                }

                row.forEach((header, i) => {
                    const th = document.createElement('th');
                    th.textContent = header;

                    if (index === 0 && i < 7) {
                        th.className = 'degree-' + (i + 1);

                        if (i === 0 || i === 3 || i === 4) {
                            th.classList.add('col-primary');
                        } else if (i === 1 || i === 2 || i === 5) {
                            th.classList.add('col-secondary');
                        } else if (i === 6) {
                            th.classList.add('col-diminished');
                        }
                    }

                    headerRow.appendChild(th);
                });

                thead.appendChild(headerRow);
            });

            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            const scalesToShow = config.selectedScales;

            scalesToShow.forEach(scale => {
                const row = document.createElement('tr');
                row.dataset.scale = scale;

                const scaleCell = document.createElement('td');
                scaleCell.className = 'scale-cell';

                const scaleName = document.createElement('span');
                scaleName.textContent = scale;
                scaleCell.appendChild(scaleName);

                const clearRowBtn = document.createElement('button');
                clearRowBtn.className = 'clear-row-btn';
                clearRowBtn.textContent = '×';
                clearRowBtn.title = 'Clear all chords in this scale';
                clearRowBtn.onclick = function(e) {
                    e.stopPropagation();
                    clearScaleRow(row);
                };
                scaleCell.appendChild(clearRowBtn);

                row.appendChild(scaleCell);

                for (let degree = 0; degree < 7; degree++) {
                    const cell = document.createElement('td');

                    if (degree === 0 || degree === 3 || degree === 4) {
                        cell.classList.add('cell-primary');
                    } else if (degree === 1 || degree === 2 || degree === 5) {
                        cell.classList.add('cell-secondary');
                    } else if (degree === 6) {
                        cell.classList.add('cell-diminished');
                    }

                    const dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.dataset.scale = scale;
                    dropZone.dataset.degree = degree;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = '×';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        removeChordFromCell(dropZone);
                    };

                    dropZone.appendChild(removeBtn);

                    dropZone.addEventListener('dragover', handleDragOver);
                    dropZone.addEventListener('dragleave', handleDragLeave);
                    dropZone.addEventListener('drop', handleDrop);

                    dropZone.addEventListener('click', function(e) {
                        if (!this.classList.contains('filled')) {
                            showChordDropdown(this);
                        }
                    });

                    cell.appendChild(dropZone);
                    row.appendChild(cell);
                }

                const infoCell = document.createElement('td');
                infoCell.textContent = scales[scale].accidentals;
                infoCell.className = 'info-cell';
                row.appendChild(infoCell);

                tbody.appendChild(row);
            });

            table.appendChild(tbody);

            userAnswers = {};
        }

        function handleDragStart(e) {
            draggedChord = e.target.dataset.chord;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');

            let dropZone = e.target;

            if (dropZone.classList.contains('remove-btn')) {
                dropZone = dropZone.parentElement;
            }

            const scale = dropZone.dataset.scale;
            const degree = parseInt(dropZone.dataset.degree);

            const existingChord = dropZone.querySelector('.chord-text');
            if (existingChord) {
                existingChord.remove();
            }

            const chordText = document.createElement('span');
            chordText.className = 'chord-text';
            chordText.textContent = draggedChord;
            dropZone.appendChild(chordText);

            dropZone.classList.add('filled');
            dropZone.classList.remove('correct', 'incorrect');

            const key = scale + '-' + degree;
            userAnswers[key] = draggedChord;

            if (config.validation === 'instant') {
                validateCell(dropZone, scale, degree);
            }

            updateProgress();
            updateScaleClearButtons();
        }

        function removeChordFromCell(dropZone) {
            const chordText = dropZone.querySelector('.chord-text');
            if (!chordText) return;

            const scale = dropZone.dataset.scale;
            const degree = parseInt(dropZone.dataset.degree);
            const key = scale + '-' + degree;

            delete userAnswers[key];

            chordText.remove();
            dropZone.classList.remove('filled', 'correct', 'incorrect');

            updateProgress();
            updateScaleClearButtons();
        }

        function clearScaleRow(row) {
            const scale = row.dataset.scale;

            const dropZones = row.querySelectorAll('.drop-zone');

            dropZones.forEach(dropZone => {
                const chordText = dropZone.querySelector('.chord-text');
                if (chordText) {
                    const degree = parseInt(dropZone.dataset.degree);
                    const key = scale + '-' + degree;

                    delete userAnswers[key];

                    chordText.remove();
                    dropZone.classList.remove('filled', 'correct', 'incorrect');
                }
            });

            updateProgress();
            updateScaleClearButtons();
        }

        function updateScaleClearButtons() {
            const rows = document.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const scaleCell = row.querySelector('.scale-cell');
                if (!scaleCell) return;

                const dropZones = row.querySelectorAll('.drop-zone');
                const hasAnyChord = Array.from(dropZones).some(zone =>
                    zone.querySelector('.chord-text')
                );

                if (hasAnyChord) {
                    scaleCell.classList.add('has-chords');
                } else {
                    scaleCell.classList.remove('has-chords');
                }
            });
        }

        function showChordDropdown(dropZone) {
            let availableChords = [];
            const chordElements = document.querySelectorAll('#chordBank .chord:not(.used)');
            chordElements.forEach(el => {
                availableChords.push(el.dataset.chord);
            });

            if (availableChords.length === 0) {
                return;
            }

            availableChords.sort();

            currentDropZone = dropZone;

            const rect = dropZone.getBoundingClientRect();

            const modal = document.getElementById('chordModal');

            modal.innerHTML = '';

            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#5c6bc0';
            const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim() || '#ffffff';
            const bgTertiary = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-modal-btn';
            closeBtn.textContent = '×';
            closeBtn.style.position = 'sticky';
            closeBtn.style.top = '0';
            closeBtn.style.right = '8px';
            closeBtn.style.float = 'right';
            closeBtn.style.width = '28px';
            closeBtn.style.height = '28px';
            closeBtn.style.border = '1px solid var(--border-color)';
            closeBtn.style.borderRadius = '6px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.fontSize = '20px';
            closeBtn.style.fontWeight = '300';
            closeBtn.style.padding = '0';
            closeBtn.style.display = 'flex';
            closeBtn.style.alignItems = 'center';
            closeBtn.style.justifyContent = 'center';
            closeBtn.style.zIndex = '10001';
            closeBtn.style.marginBottom = '8px';
            closeBtn.style.marginLeft = 'auto';
            closeBtn.style.backgroundColor = bgTertiary;
            closeBtn.style.color = textColor;

            closeBtn.onmouseenter = function() {
                this.style.backgroundColor = '#f44336';
                this.style.color = 'white';
                this.style.borderColor = '#f44336';
            };

            closeBtn.onmouseleave = function() {
                this.style.backgroundColor = bgTertiary;
                this.style.color = textColor;
                this.style.borderColor = '';
            };

            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeChordModal();
            };
            modal.appendChild(closeBtn);

            availableChords.forEach(chord => {
                const option = document.createElement('div');
                option.className = 'modal-option';
                option.textContent = chord;
                option.dataset.chord = chord;
                option.style.cursor = 'pointer';
                option.style.padding = '8px 12px';
                option.style.borderRadius = '4px';
                option.style.marginBottom = '2px';
                option.style.border = '1px solid transparent';

                option.addEventListener('mouseenter', function() {
                    // Remove keyboard focus from all options when hovering
                    const allOptions = modal.querySelectorAll('.modal-option');
                    allOptions.forEach(opt => opt.classList.remove('keyboard-focused'));

                    this.style.backgroundColor = accentColor;
                    this.style.color = 'white';
                });

                option.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '';
                });

                option.onclick = function(e) {
                    e.stopPropagation();
                    const chordToAdd = this.dataset.chord;
                    const zone = currentDropZone;
                    closeChordModal();
                    if (zone) {
                        addChordToCell(zone, chordToAdd);
                    }
                };
                modal.appendChild(option);
            });

            let modalTop = rect.bottom + window.scrollY + 5;
            let modalLeft = rect.left + window.scrollX;

            modal.style.position = 'fixed';
            modal.style.zIndex = '10000';
            modal.style.height = '350px';
            modal.style.maxHeight = '350px';
            modal.style.overflowY = 'scroll';

            modal.style.display = 'block';
            modal.style.visibility = 'hidden';
            modal.style.left = '0px';
            modal.style.top = '0px';

            const modalRect = modal.getBoundingClientRect();
            const modalHeight = 350;

            // Calculate available space below and above the cell
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;

            // Decide position based on available space
            if (spaceBelow >= modalHeight + 10) {
                // Enough space below - position below the cell
                modalTop = rect.bottom + 5;
            } else if (spaceAbove >= modalHeight + 10) {
                // Not enough space below but enough above - position above the cell
                modalTop = rect.top - modalHeight - 5;
            } else {
                // Not enough space either way - position where there's more space
                if (spaceAbove > spaceBelow) {
                    modalTop = rect.top - modalHeight - 5;
                    // Make sure it doesn't go above viewport
                    if (modalTop < 10) {
                        modalTop = 10;
                    }
                } else {
                    modalTop = rect.bottom + 5;
                    // Make sure it doesn't go below viewport
                    if (modalTop + modalHeight > window.innerHeight - 10) {
                        modalTop = window.innerHeight - modalHeight - 10;
                    }
                }
            }

            // Handle horizontal positioning
            modalLeft = rect.left;

            // Check if modal goes beyond right edge
            if (modalLeft + modalRect.width > window.innerWidth) {
                modalLeft = window.innerWidth - modalRect.width - 10;
            }

            // Check if modal goes beyond left edge
            if (modalLeft < 10) {
                modalLeft = 10;
            }

            modal.style.left = modalLeft + 'px';
            modal.style.top = modalTop + 'px';
            modal.style.visibility = 'visible';
            modal.style.display = 'block';
            modal.style.backgroundColor = bgColor;
            modal.style.border = '2px solid #000000';
            modal.style.padding = '6px';
            modal.style.borderRadius = '8px';
            modal.style.width = '200px';

            modal.classList.add('active');

            modal.onclick = function(e) {
                e.stopPropagation();
            };

            setTimeout(() => {
                document.addEventListener('click', handleClickOutsideModal, true);
                document.addEventListener('keydown', handleModalKeyPress, true);
            }, 100);
        }

        function handleModalKeyPress(e) {
            const modal = document.getElementById('chordModal');
            if (!modal.classList.contains('active')) return;

            const key = e.key.toUpperCase();

            if (key >= 'A' && key <= 'G') {
                e.preventDefault();

                const options = modal.querySelectorAll('.modal-option');
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#5c6bc0';

                // Reset all options
                options.forEach(opt => {
                    opt.classList.remove('keyboard-focused');
                    opt.style.backgroundColor = 'transparent';
                    opt.style.color = '';
                });

                let foundOption = null;
                for (let option of options) {
                    const chordName = option.dataset.chord;
                    if (chordName.charAt(0).toUpperCase() === key) {
                        foundOption = option;
                        break;
                    }
                }

                if (foundOption) {
                    foundOption.classList.add('keyboard-focused');
                    foundOption.style.backgroundColor = accentColor;
                    foundOption.style.color = 'white';
                    foundOption.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function handleClickOutsideModal(e) {
            const modal = document.getElementById('chordModal');

            if (!modal.contains(e.target) && modal.classList.contains('active')) {
                closeChordModal();
                document.removeEventListener('click', handleClickOutsideModal, true);
            }
        }

        function closeChordModal() {
            const modal = document.getElementById('chordModal');
            modal.classList.remove('active');
            modal.style.display = 'none';

            document.removeEventListener('click', handleClickOutsideModal, true);
            document.removeEventListener('keydown', handleModalKeyPress, true);
        }

        function addChordToCell(dropZone, chord) {
            const scale = dropZone.dataset.scale;
            const degree = parseInt(dropZone.dataset.degree);

            const existingText = dropZone.querySelector('.chord-text');
            if (existingText) {
                existingText.remove();
            }

            const chordText = document.createElement('span');
            chordText.className = 'chord-text';
            chordText.textContent = chord;
            dropZone.appendChild(chordText);

            dropZone.classList.add('filled');
            dropZone.classList.remove('correct', 'incorrect');

            const key = scale + '-' + degree;
            userAnswers[key] = chord;

            if (config.validation === 'instant') {
                validateCell(dropZone, scale, degree);
            }

            updateProgress();

            currentDropZone = null;

            updateScaleClearButtons();
        }

        function validateCell(dropZone, scale, degree) {
            const chordText = dropZone.querySelector('.chord-text');
            if (!chordText) return;

            const userChord = chordText.textContent.replace(' ✓', '').replace(' ✗', '');
            const correctChord = scales[scale].chords[degree];

            if (userChord === correctChord) {
                dropZone.classList.add('correct');
                dropZone.classList.remove('incorrect');
            } else {
                dropZone.classList.add('incorrect');
                dropZone.classList.remove('correct');
            }
        }

        function checkAllAnswers() {
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => {
                const chordText = zone.querySelector('.chord-text');
                if (chordText) {
                    const scale = zone.dataset.scale;
                    const degree = parseInt(zone.dataset.degree);
                    validateCell(zone, scale, degree);
                }
            });
            updateProgress();
        }

        function resetApp() {
            if (config.timer > 0) {
                if (confirm('Reset will restart the timer. Continue?')) {
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                    startTimer(config.timer);
                } else {
                    return;
                }
            }
            buildChordBank();
            buildTable();
            updateProgress();
        }

        function updateProgress() {
            const totalCells = config.selectedScales.length * 7;
            const filled = Object.keys(userAnswers).length;

            let correct = 0;
            if (config.validation === 'instant' || document.querySelectorAll('.correct').length > 0) {
                correct = document.querySelectorAll('.correct').length;
            }

            const progressEl = document.getElementById('progress');
            progressEl.innerHTML = `Filled: ${filled}/${totalCells}`;

            if (correct > 0) {
                progressEl.innerHTML += ` | Correct: ${correct}/${filled}`;
            }

            if (filled === totalCells && correct === totalCells) {
                progressEl.innerHTML += ` | 🎉 Congratulations! All answers are correct!`;

                // Stop timer if running
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            } else if (filled === totalCells) {
                // All cells filled but not all correct - stop timer anyway
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }
        }
    </script>
</body>
</html>